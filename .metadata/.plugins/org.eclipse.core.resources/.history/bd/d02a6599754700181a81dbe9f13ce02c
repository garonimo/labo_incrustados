#include "msp.h"

#include "driverlib.h"
#include "HAL_I2C.h"
#include "HAL_OPT3001.h"
#include <iostream>



void BlinkLEDs(int l_intBlinkTime)
{
    for(int i = 0; i < l_intBlinkTime; i++);
    P2->OUT ^= BIT0 | BIT1 | BIT2;

    for(int i = 0; i < l_intBlinkTime; i++); //1
    P2->OUT ^= BIT0 | BIT1 | BIT2;

    for(int i = 0; i < l_intBlinkTime; i++);
    P2->OUT ^= BIT0 | BIT1 | BIT2;

    for(int i = 0; i < l_intBlinkTime; i++);//2
    P2->OUT ^= BIT0 | BIT1 | BIT2;

    for(int i = 0; i < l_intBlinkTime; i++);
    P2->OUT ^= BIT0 | BIT1 | BIT2;

    for(int i = 0; i < l_intBlinkTime; i++);//3
    P2->OUT ^= BIT0 | BIT1 | BIT2;

}

void ADC_SetUp()
{
    // Configure GPIO
    P4->SEL1 |= BIT3;         // Enable A/D channel A0
    P4->SEL0 |= BIT3;         // and VeREF+ and VeREF-

    // Configure ADC14
    // Turn on ADC14, set sampling time
    ADC14->CTL0 = ADC14_CTL0_ON | ADC14_CTL0_SHP| ADC14_CTL0_SHT0_2;
    // Use sampling timer, 14-bit conversion results
    ADC14->CTL1 = ADC14_CTL1_RES_3;
    // Vr+ = VeREF+ (ext) and Vr-=VeREF-, A0
    ADC14->MCTL[0] = ADC14_MCTLN_VRSEL_14 | ADC14_MCTLN_INCH_0;
    // Enable conversions
    ADC14->CTL0 |= ADC14_CTL0_ENC;
}

void ligthSensor_SetUp()
{
    /* Initializes Clock System */
    MAP_CS_setDCOCenteredFrequency(CS_DCO_FREQUENCY_48);
    MAP_CS_initClockSignal(CS_MCLK, CS_DCOCLK_SELECT, CS_CLOCK_DIVIDER_1 );
    MAP_CS_initClockSignal(CS_HSMCLK, CS_DCOCLK_SELECT, CS_CLOCK_DIVIDER_1 );
    MAP_CS_initClockSignal(CS_SMCLK, CS_DCOCLK_SELECT, CS_CLOCK_DIVIDER_1 );
    MAP_CS_initClockSignal(CS_ACLK, CS_REFOCLK_SELECT, CS_CLOCK_DIVIDER_1);


    /* Initialize I2C communication */
    Init_I2C_GPIO();
    I2C_init();

    /* Initialize OPT3001 digital ambient light sensor */
    OPT3001_init();

    __delay_cycles(100000);
}

void Set_Status()
{

   float l_floatLightSensorValue;
   volatile uint16_t l_uint16SoundSensorValue;

   while(1)
    {

       l_floatLightSensorValue = OPT3001_getLux();

       P2->OUT &= 11111000;

       if (l_floatLightSensorValue < 20)
       {
           P2->OUT |= BIT1;
       }
       else
       {
           P2->OUT |= BIT0;
       }

       ADC14->CTL0 |= ADC14_CTL0_SC;       // Start conversion-software trigger
       while (!(ADC14->IFGR0 & BIT0));
       ADCvar = ADC14->MEM[0];             // Read conversion result

    }
}

void initialConfiguration()
{
    int l_intBlinkTime = 55000;

    P2->DIR = BIT0 | BIT1 | BIT2;
    P2->OUT = BIT0 | BIT1 | BIT2;

    BlinkLEDs(l_intBlinkTime);

    ligthSensor_SetUp();
    ADC_SetUp();            //Microphone
    //Timer_setUp();        //To set timer
    //Ctrol_button_SetUp(); //To set button
    Set_Status();
}

